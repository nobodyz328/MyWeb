<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™»å½• / æ³¨å†Œ - MySteamç¤¾åŒº</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      background: linear-gradient(135deg, #171a21 0%, #1b2838 50%, #2a475e 100%);
      color: #c7d5e0;
      font-family: 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 80%, rgba(102, 192, 244, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(102, 192, 244, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }
    .auth-container { 
      max-width: 450px; 
      width: 90%; 
      background: rgba(35, 38, 46, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px; 
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(102, 192, 244, 0.2);
      padding: 40px; 
    }
    .auth-tabs { 
      display: flex; 
      justify-content: center; 
      gap: 32px; 
      margin-bottom: 32px; 
      border-bottom: 1px solid rgba(102, 192, 244, 0.2); 
    }
    .auth-tabs button { 
      background: none; 
      border: none; 
      color: #c7d5e0; 
      font-size: 1.1rem; 
      cursor: pointer; 
      padding: 12px 24px; 
      border-bottom: 3px solid transparent; 
      transition: all 0.3s; 
      font-weight: 500; 
    }
    .auth-tabs .active { 
      color: #66c0f4; 
      border-bottom: 3px solid #66c0f4; 
      font-weight: 600;
      text-shadow: 0 0 10px rgba(102, 192, 244, 0.5);
    }
    .auth-form { display: flex; flex-direction: column; gap: 20px; }
    .input-group { position: relative; }
    .input-group label { 
      display: block; 
      margin-bottom: 5px; 
      color: #c7d5e0; 
      font-weight: 500; 
      font-size: 0.9rem; 
    }
    .input-group input { 
      width: 100%; 
      background: rgba(27, 40, 56, 0.8);
      border: 1px solid rgba(102, 192, 244, 0.3);
      border-radius: 8px; 
      color: #c7d5e0; 
      padding: 12px 15px; 
      font-size: 1rem; 
      transition: all 0.3s; 
      box-sizing: border-box; 
    }
    .input-group input:focus { 
      outline: none; 
      border-color: #66c0f4; 
      background: rgba(27, 40, 56, 1);
      box-shadow: 0 0 0 3px rgba(102, 192, 244, 0.1);
    }
    .input-group input::placeholder {
      color: rgba(199, 213, 224, 0.6);
    }
    .input-group .error { color: #ff6b6b; font-size: 0.8rem; margin-top: 5px; }
    .input-group .success { color: #51cf66; font-size: 0.8rem; margin-top: 5px; }
    .verification-row { display: flex; gap: 12px; align-items: flex-end; }
    .verification-row input { flex: 1; }
    .verification-btn { 
      background: linear-gradient(135deg, #66c0f4 0%, #4a9eff 100%);
      color: white; 
      border: none; 
      border-radius: 8px; 
      padding: 12px 16px; 
      cursor: pointer; 
      font-size: 0.9rem; 
      transition: all 0.3s; 
      white-space: nowrap;
      box-shadow: 0 2px 10px rgba(102, 192, 244, 0.3);
    }
    .verification-btn:hover { 
      background: linear-gradient(135deg, #4a9eff 0%, #66c0f4 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(102, 192, 244, 0.4);
    }
    .verification-btn:disabled { 
      background: rgba(102, 192, 244, 0.3); 
      cursor: not-allowed; 
      transform: none;
      box-shadow: none;
    }
    .steam-btn { 
      width: 100%; 
      background: linear-gradient(135deg, #66c0f4 0%, #4a9eff 100%);
      color: white; 
      border: none; 
      border-radius: 8px; 
      padding: 15px; 
      font-size: 1.1rem; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.3s; 
      margin-top: 10px;
      box-shadow: 0 4px 20px rgba(102, 192, 244, 0.3);
    }
    .steam-btn:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 8px 30px rgba(102, 192, 244, 0.4);
      background: linear-gradient(135deg, #4a9eff 0%, #66c0f4 100%);
    }
    .steam-btn:disabled { 
      background: rgba(102, 192, 244, 0.3); 
      cursor: not-allowed; 
      transform: none; 
      box-shadow: none; 
    }
    .password-strength { margin-top: 5px; }
    .strength-bar { 
      height: 4px; 
      border-radius: 2px; 
      background: rgba(199, 213, 224, 0.2); 
      overflow: hidden; 
    }
    .strength-fill { height: 100%; transition: all 0.3s; }
    .strength-weak { background: #ff6b6b; width: 25%; }
    .strength-medium { background: #ffd43b; width: 50%; }
    .strength-strong { background: #51cf66; width: 75%; }
    .strength-very-strong { background: #66c0f4; width: 100%; }
    .strength-text { 
      font-size: 0.8rem; 
      margin-top: 2px; 
      color: #c7d5e0;
    }
    .loading { 
      display: inline-block; 
      width: 16px; 
      height: 16px; 
      border: 2px solid rgba(255, 255, 255, 0.3); 
      border-top: 2px solid #66c0f4; 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .back-to-home {
      position: absolute;
      top: 20px;
      left: 20px;
      color: #66c0f4;
      text-decoration: none;
      font-size: 1rem;
      transition: all 0.3s;
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid rgba(102, 192, 244, 0.3);
      background: rgba(35, 38, 46, 0.8);
    }
    .back-to-home:hover {
      background: rgba(102, 192, 244, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 192, 244, 0.2);
    }
  </style>
</head>
<body>
  <a href="/blog/view" class="back-to-home">â† è¿”å›é¦–é¡µ</a>
  <div class="auth-container">
    <div class="auth-tabs">
      <button class="active" id="loginTab">ç™»å½•</button>
      <button id="registerTab">æ³¨å†Œ</button>
    </div>
    
    <!-- ç™»å½•è¡¨å• -->
    <form class="auth-form" id="loginForm">
      <div class="input-group">
        <label for="loginUsername">ç”¨æˆ·åæˆ–é‚®ç®±</label>
        <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±" required>
        <div class="error" id="loginUsernameError"></div>
      </div>
      
      <div class="input-group">
        <label for="loginPassword">å¯†ç </label>
        <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
        <div class="error" id="loginPasswordError"></div>
      </div>
      
      <div class="verification-row" style="display:none;" id="loginCaptchaRow">
        <div class="input-group">
          <label for="loginCaptcha">éªŒè¯ç </label>
          <input type="text" id="loginCaptcha" placeholder="è¯·è¾“å…¥éªŒè¯ç ">
          <div class="error" id="loginCaptchaError"></div>
        </div>
      </div>
      
      <div class="input-group" style="display:none;" id="loginTotpRow">
        <label for="loginTotp">TOTPéªŒè¯ç </label>
        <input type="text" id="loginTotp" placeholder="è¯·è¾“å…¥6ä½TOTPéªŒè¯ç " maxlength="6" pattern="[0-9]{6}">
        <div class="error" id="loginTotpError"></div>
        <div style="font-size: 0.8rem; color: #66c0f4; margin-top: 5px;">
          ğŸ” ç®¡ç†å‘˜ç™»å½•éœ€è¦æä¾›TOTPéªŒè¯ç 
        </div>
      </div>
      
      <button type="submit" class="steam-btn" id="loginBtn">ç™»å½•</button>
    </form>
    
    <!-- æ³¨å†Œè¡¨å• -->
    <form class="auth-form" id="registerForm" style="display:none;">
      <div class="input-group">
        <label for="registerUsername">ç”¨æˆ·å</label>
        <input type="text" id="registerUsername" placeholder="3-20ä¸ªå­—ç¬¦ï¼Œæ”¯æŒå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿" required>
        <div class="error" id="registerUsernameError"></div>
        <div class="success" id="registerUsernameSuccess"></div>
      </div>
      
      <div class="input-group">
        <label for="registerEmail">é‚®ç®±åœ°å€</label>
        <input type="email" id="registerEmail" placeholder="è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€" required>
        <div class="error" id="registerEmailError"></div>
        <div class="success" id="registerEmailSuccess"></div>
      </div>
      
      <div class="verification-row">
        <div class="input-group">
          <label for="registerCode">é‚®ç®±éªŒè¯ç </label>
          <input type="text" id="registerCode" placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç " required>
          <div class="error" id="registerCodeError"></div>
        </div>
        <button type="button" class="verification-btn" id="sendCodeBtn">å‘é€éªŒè¯ç </button>
      </div>
      
      <div class="input-group">
        <label for="registerPassword">å¯†ç </label>
        <input type="password" id="registerPassword" placeholder="8-50ä¸ªå­—ç¬¦ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—" required>
        <div class="password-strength" id="passwordStrength" style="display:none;">
          <div class="strength-bar">
            <div class="strength-fill" id="strengthFill"></div>
          </div>
          <div class="strength-text" id="strengthText"></div>
        </div>
        <div class="error" id="registerPasswordError"></div>
      </div>
      
      <div class="input-group">
        <label for="confirmPassword">ç¡®è®¤å¯†ç </label>
        <input type="password" id="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
        <div class="error" id="confirmPasswordError"></div>
        <div class="success" id="confirmPasswordSuccess"></div>
      </div>
      
      <button type="submit" class="steam-btn" id="registerBtn">æ³¨å†Œ</button>
    </form>
  </div>
  <script>
    // å…¨å±€å˜é‡
    let sendCodeTimer = null;
    let sendCodeCountdown = 0;
    let passwordRules = null;
    
    // å·¥å…·å‡½æ•°
    function showError(elementId, message) {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = message;
        element.style.display = 'block';
      }
    }
    
    function hideError(elementId) {
      const element = document.getElementById(elementId);
      if (element) {
        element.style.display = 'none';
      }
    }
    
    function showSuccess(elementId, message) {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = message;
        element.style.display = 'block';
      }
    }
    
    function hideSuccess(elementId) {
      const element = document.getElementById(elementId);
      if (element) {
        element.style.display = 'none';
      }
    }
    
    // åŠ è½½å¯†ç éªŒè¯è§„åˆ™
    async function loadPasswordRules() {
      if (passwordRules) return passwordRules;

          // ä½¿ç”¨é»˜è®¤è§„åˆ™
          passwordRules = {
            minLength: 8,
            maxLength: 50,
            pattern: "^(?=.*[A-Za-z])(?=.*\\d)[A-Za-z\\d@$!%*#?&]{8,50}$",
            weakPasswords: [],
            weakPatterns: [
              "(.)\\1{2,}",
              "(0123|1234|2345|3456|4567|5678|6789|9876|8765|7654|6543|5432|4321|3210)",
              "(?i)(abcd|bcde|cdef|defg|efgh|fghi|ghij|hijk|ijkl|jklm|klmn|lmno|mnop|nopq|opqr|pqrs|qrst|rstu|stuv|tuvw|uvwx|vwxy|wxyz)",
              "(?i)(qwer|wert|erty|rtyu|tyui|yuio|uiop|asdf|sdfg|dfgh|fghj|ghjk|hjkl|zxcv|xcvb|cvbn|vbnm)"
            ]
          };
      return passwordRules;
    }
    
    // å¯†ç å¼ºåº¦æ£€æµ‹ï¼ˆä¸åç«¯ä¿æŒä¸€è‡´ï¼‰
    async function checkPasswordStrength(password) {
      const rules = await loadPasswordRules();
      let score = 0;
      let feedback = [];
      let isWeak = false;
      
      // åŸºæœ¬é•¿åº¦æ£€æŸ¥
      if (password.length >= rules.minLength) score++;
      else feedback.push(`è‡³å°‘${rules.minLength}ä¸ªå­—ç¬¦`);
      
      if (password.length >= 12) score++; // é•¿åº¦åŠ åˆ†
      
      // å­—ç¬¦ç±»å‹æ£€æŸ¥
      if (/[a-z]/.test(password)) score++;
      else feedback.push('åŒ…å«å°å†™å­—æ¯');
      
      if (/[A-Z]/.test(password)) score++;
      else feedback.push('åŒ…å«å¤§å†™å­—æ¯');
      
      if (/\d/.test(password)) score++;
      else feedback.push('åŒ…å«æ•°å­—');
      
      if (/[@$!%*#?&]/.test(password)) score++;
      else feedback.push('åŒ…å«ç‰¹æ®Šå­—ç¬¦');
      
      // å¼±å¯†ç æ£€æŸ¥
      const lowerPassword = password.toLowerCase();
      
      // æ£€æŸ¥å¼±å¯†ç åˆ—è¡¨
      if (rules.weakPasswords) {
        for (const weakPassword of rules.weakPasswords) {
          if (lowerPassword === weakPassword || lowerPassword.includes(weakPassword)) {
            isWeak = true;
            feedback.push('ä¸èƒ½ä½¿ç”¨å¸¸è§å¼±å¯†ç ');
            break;
          }
        }
      }
      
      // æ£€æŸ¥å¼±å¯†ç æ¨¡å¼
      if (!isWeak && rules.weakPatterns) {
        for (const patternStr of rules.weakPatterns) {
          try {
            const pattern = new RegExp(patternStr);
            if (pattern.test(password)) {
              isWeak = true;
              feedback.push('ä¸èƒ½åŒ…å«ç®€å•çš„å­—ç¬¦åºåˆ—');
              break;
            }
          } catch (e) {
            console.warn('æ— æ•ˆçš„æ­£åˆ™è¡¨è¾¾å¼:', patternStr);
          }
        }
      }
      
      // å¦‚æœæ˜¯å¼±å¯†ç ï¼Œé™ä½åˆ†æ•°
      if (isWeak) {
        score = Math.max(0, score - 2);
      }
      
      return { score, feedback, isWeak };
    }
    
    async function updatePasswordStrength(password) {
      const strengthDiv = document.getElementById('passwordStrength');
      const strengthFill = document.getElementById('strengthFill');
      const strengthText = document.getElementById('strengthText');
      
      if (!password) {
        strengthDiv.style.display = 'none';
        return;
      }
      
      strengthDiv.style.display = 'block';
      const { score, feedback, isWeak } = await checkPasswordStrength(password);
      
      // æ›´æ–°å¼ºåº¦æ¡
      strengthFill.className = 'strength-fill';
      
      let strengthLevel = '';
      let strengthColor = '';
      
      if (isWeak || score <= 1) {
        strengthFill.classList.add('strength-weak');
        strengthLevel = 'å¼±';
        strengthColor = '#ff6b6b';
      } else if (score <= 2) {
        strengthFill.classList.add('strength-medium');
        strengthLevel = 'ä¸­ç­‰';
        strengthColor = '#ffd43b';
      } else if (score <= 4) {
        strengthFill.classList.add('strength-strong');
        strengthLevel = 'å¼º';
        strengthColor = '#51cf66';
      } else {
        strengthFill.classList.add('strength-very-strong');
        strengthLevel = 'å¾ˆå¼º';
        strengthColor = '#66c0f4';
      }
      
      strengthText.textContent = strengthLevel;
      strengthText.style.color = strengthColor;
      
      // æ˜¾ç¤ºæ”¹è¿›å»ºè®®
      if (feedback.length > 0 && (isWeak || score < 3)) {
        strengthText.textContent += ' - ' + feedback.slice(0, 2).join(', ');
      }
    }
    
    // ç”¨æˆ·åå¯ç”¨æ€§æ£€æŸ¥
    async function checkUsernameAvailability(username) {
      if (!username || username.length < 3) return;
      
      try {
        const response = await fetch(`/blog/users/check-username?username=${encodeURIComponent(username)}`);
        const data = await response.json();
        
        if (data.available) {
          hideError('registerUsernameError');
          showSuccess('registerUsernameSuccess', 'âœ“ ç”¨æˆ·åå¯ç”¨');
        } else {
          hideSuccess('registerUsernameSuccess');
          showError('registerUsernameError', 'ç”¨æˆ·åå·²è¢«ä½¿ç”¨');
        }
      } catch (error) {
        console.error('æ£€æŸ¥ç”¨æˆ·åå¤±è´¥:', error);
      }
    }
    
    // é‚®ç®±å¯ç”¨æ€§æ£€æŸ¥
    async function checkEmailAvailability(email) {
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return;
      
      try {
        const response = await fetch(`/blog/users/check-email?email=${encodeURIComponent(email)}`);
        const data = await response.json();
        
        if (data.available) {
          hideError('registerEmailError');
          showSuccess('registerEmailSuccess', 'âœ“ é‚®ç®±å¯ç”¨');
        } else {
          hideSuccess('registerEmailSuccess');
          showError('registerEmailError', 'é‚®ç®±å·²è¢«æ³¨å†Œ');
        }
      } catch (error) {
        console.error('æ£€æŸ¥é‚®ç®±å¤±è´¥:', error);
      }
    }
    
    // å‘é€éªŒè¯ç 
    async function sendVerificationCode() {
      const email = document.getElementById('registerEmail').value;
      const sendCodeBtn = document.getElementById('sendCodeBtn');
      
      if (!email) {
        showError('registerEmailError', 'è¯·å…ˆè¾“å…¥é‚®ç®±åœ°å€');
        return;
      }
      
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showError('registerEmailError', 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®');
        return;
      }
      
      try {
        sendCodeBtn.disabled = true;
        sendCodeBtn.innerHTML = '<div class="loading"></div>';
        
        const response = await fetch('/blog/users/register/code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `email=${encodeURIComponent(email)}`
        });
        
        const result = await response.text();
        
        if (response.ok) {
          hideError('registerEmailError');
          showSuccess('registerEmailSuccess', 'éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±');
          startCountdown();
        } else {
          showError('registerEmailError', result || 'å‘é€éªŒè¯ç å¤±è´¥');
          sendCodeBtn.disabled = false;
          sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
        }
      } catch (error) {
        console.error('å‘é€éªŒè¯ç å¤±è´¥:', error);
        showError('registerEmailError', 'å‘é€éªŒè¯ç å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        sendCodeBtn.disabled = false;
        sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
      }
    }
    
    // å€’è®¡æ—¶
    function startCountdown() {
      const sendCodeBtn = document.getElementById('sendCodeBtn');
      sendCodeCountdown = 60;
      
      sendCodeTimer = setInterval(() => {
        sendCodeBtn.textContent = `${sendCodeCountdown}ç§’åé‡å‘`;
        sendCodeCountdown--;
        
        if (sendCodeCountdown < 0) {
          clearInterval(sendCodeTimer);
          sendCodeBtn.disabled = false;
          sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
        }
      }, 1000);
    }
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜è´¦æˆ·
    async function checkIfAdminAccount(username) {
      if (!username || username.trim().length === 0) {
        return false;
      }
      
      try {
        const response = await fetch(`/blog/users/check-admin?username=${encodeURIComponent(username)}`);
        if (response.ok) {
          const data = await response.json();
          return data.isAdmin || false;
        }
      } catch (error) {
        console.debug('æ£€æŸ¥ç®¡ç†å‘˜è´¦æˆ·å¤±è´¥:', error);
      }
      return false;
    }
    
    // ç”¨æˆ·åè¾“å…¥æ¡†å¤±ç„¦äº‹ä»¶ - æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
    document.getElementById('loginUsername').addEventListener('blur', async function() {
      const username = this.value.trim();
      const totpRow = document.getElementById('loginTotpRow');
      
      if (username) {
        const isAdmin = await checkIfAdminAccount(username);
        if (isAdmin) {
          totpRow.style.display = 'block';
        } else {
          totpRow.style.display = 'none';
          document.getElementById('loginTotp').value = ''; // æ¸…ç©ºTOTPè¾“å…¥
        }
      } else {
        totpRow.style.display = 'none';
        document.getElementById('loginTotp').value = '';
      }
    });
    
    // TOTPè¾“å…¥æ¡†åªå…è®¸æ•°å­—
    document.getElementById('loginTotp').addEventListener('input', function() {
      this.value = this.value.replace(/[^0-9]/g, '');
      if (this.value.length > 6) {
        this.value = this.value.slice(0, 6);
      }
      
      // æ¸…é™¤é”™è¯¯ä¿¡æ¯
      if (this.value.length > 0) {
        hideError('loginTotpError');
      }
    });
    
    // ç™»å½•è¡¨å•æäº¤
    document.getElementById('loginForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      const captchaCode = document.getElementById('loginCaptcha').value || '';
      const totpCode = document.getElementById('loginTotp').value || '';
      const loginBtn = document.getElementById('loginBtn');
      
      // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
      hideError('loginUsernameError');
      hideError('loginPasswordError');
      hideError('loginCaptchaError');
      hideError('loginTotpError');
      
      if (!username) {
        showError('loginUsernameError', 'è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±');
        return;
      }
      
      if (!password) {
        showError('loginPasswordError', 'è¯·è¾“å…¥å¯†ç ');
        return;
      }
      
      // æ£€æŸ¥ç®¡ç†å‘˜æ˜¯å¦æä¾›äº†TOTPéªŒè¯ç 
      const isAdmin = await checkIfAdminAccount(username);
      if (isAdmin && (!totpCode || totpCode.length !== 6)) {
        showError('loginTotpError', 'ç®¡ç†å‘˜ç™»å½•éœ€è¦æä¾›6ä½TOTPéªŒè¯ç ');
        return;
      }
      
      try {
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<div class="loading"></div> ç™»å½•ä¸­...';
        
        // ä½¿ç”¨TOTPéªŒè¯ç ä½œä¸ºcodeå‚æ•°
        const code = isAdmin ? totpCode : captchaCode;
        
        const response = await fetch('/blog/users/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, code })
        });
        
        const data = await response.json();
        
        if (response.ok && data.id) {
          // Store JWT tokens and user info
          localStorage.setItem('accessToken', data.accessToken);
          localStorage.setItem('refreshToken', data.refreshToken);
          localStorage.setItem('userId', data.id);
          localStorage.setItem('username', data.username);
          localStorage.setItem('tokenType', data.tokenType || 'Bearer');
          localStorage.setItem('expiresIn', data.expiresIn);
          
          window.location.href = '/blog/view';
        } else {
          const errorMsg = typeof data === 'string' ? data : 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ';
          if (isAdmin && errorMsg.includes('TOTP')) {
            showError('loginTotpError', errorMsg);
          } else {
            showError('loginPasswordError', errorMsg);
          }
        }
      } catch (error) {
        console.error('ç™»å½•å¤±è´¥:', error);
        showError('loginPasswordError', 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'ç™»å½•';
      }
    };
    
    // æ³¨å†Œè¡¨å•æäº¤
    document.getElementById('registerForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const username = document.getElementById('registerUsername').value;
      const email = document.getElementById('registerEmail').value;
      const code = document.getElementById('registerCode').value;
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const registerBtn = document.getElementById('registerBtn');
      
      // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
      hideError('registerUsernameError');
      hideError('registerEmailError');
      hideError('registerCodeError');
      hideError('registerPasswordError');
      hideError('confirmPasswordError');
      
      // è¡¨å•éªŒè¯
      let hasError = false;
      
      if (!username || username.length < 3 || username.length > 20) {
        showError('registerUsernameError', 'ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-20ä¸ªå­—ç¬¦ä¹‹é—´');
        hasError = true;
      }
      
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showError('registerEmailError', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
        hasError = true;
      }
      
      if (!code || !/^\d{6}$/.test(code)) {
        showError('registerCodeError', 'è¯·è¾“å…¥6ä½æ•°å­—éªŒè¯ç ');
        hasError = true;
      }
      
      // å¯†ç éªŒè¯
      if (!password) {
        showError('registerPasswordError', 'å¯†ç ä¸èƒ½ä¸ºç©º');
        hasError = true;
      } else {
        const rules = await loadPasswordRules();
        
        if (password.length < rules.minLength) {
          showError('registerPasswordError', `å¯†ç é•¿åº¦ä¸èƒ½å°‘äº${rules.minLength}ä¸ªå­—ç¬¦`);
          hasError = true;
        } else if (password.length > rules.maxLength) {
          showError('registerPasswordError', `å¯†ç é•¿åº¦ä¸èƒ½è¶…è¿‡${rules.maxLength}ä¸ªå­—ç¬¦`);
          hasError = true;
        } else {
          // æ£€æŸ¥å¯†ç æ ¼å¼
          const pattern = new RegExp(rules.pattern);
          if (!pattern.test(password)) {
            showError('registerPasswordError', 'å¯†ç å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå­—æ¯å’Œä¸€ä¸ªæ•°å­—');
            hasError = true;
          } else {
            // æ£€æŸ¥å¯†ç å¼ºåº¦
            const { score, isWeak } = await checkPasswordStrength(password);
            if (isWeak || score < 3) {
              showError('registerPasswordError', 'å¯†ç å¼ºåº¦ä¸å¤Ÿï¼Œè¯·ä½¿ç”¨æ›´å¤æ‚çš„å¯†ç ');
              hasError = true;
            }
          }
        }
      }
      
      if (password !== confirmPassword) {
        showError('confirmPasswordError', 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
        hasError = true;
      }
      
      if (hasError) return;
      
      try {
        registerBtn.disabled = true;
        registerBtn.innerHTML = '<div class="loading"></div> æ³¨å†Œä¸­...';
        
        const response = await fetch('/blog/users/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password, code })
        });
        
        const data = await response.json();
        
        if (response.ok && data.id) {
          alert('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•æ‚¨çš„è´¦æˆ·');
          document.getElementById('loginTab').click();
          // æ¸…ç©ºæ³¨å†Œè¡¨å•
          document.getElementById('registerForm').reset();
          hideError('registerUsernameError');
          hideError('registerEmailError');
          hideError('registerCodeError');
          hideError('registerPasswordError');
          hideError('confirmPasswordError');
          hideSuccess('registerUsernameSuccess');
          hideSuccess('registerEmailSuccess');
          hideSuccess('confirmPasswordSuccess');
        } else {
          const errorMsg = typeof data === 'string' ? data : 'æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯';
          showError('registerPasswordError', errorMsg);
        }
      } catch (error) {
        console.error('æ³¨å†Œå¤±è´¥:', error);
        showError('registerPasswordError', 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        registerBtn.disabled = false;
        registerBtn.textContent = 'æ³¨å†Œ';
      }
    };
    
    // äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('registerUsername').addEventListener('blur', function() {
      checkUsernameAvailability(this.value);
    });
    
    document.getElementById('registerEmail').addEventListener('blur', function() {
      checkEmailAvailability(this.value);
    });
    
    document.getElementById('registerPassword').addEventListener('input', function() {
      updatePasswordStrength(this.value);
    });
    
    document.getElementById('confirmPassword').addEventListener('input', function() {
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = this.value;
      
      if (confirmPassword && password !== confirmPassword) {
        showError('confirmPasswordError', 'å¯†ç ä¸ä¸€è‡´');
        hideSuccess('confirmPasswordSuccess');
      } else if (confirmPassword && password === confirmPassword) {
        hideError('confirmPasswordError');
        showSuccess('confirmPasswordSuccess', 'âœ“ å¯†ç ä¸€è‡´');
      } else {
        hideError('confirmPasswordError');
        hideSuccess('confirmPasswordSuccess');
      }
    });
    
    document.getElementById('sendCodeBtn').addEventListener('click', sendVerificationCode);
    
    // Tabåˆ‡æ¢é€»è¾‘
    const loginTab = document.getElementById('loginTab');
    const registerTab = document.getElementById('registerTab');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    
    loginTab.onclick = () => {
      loginTab.classList.add('active');
      registerTab.classList.remove('active');
      loginForm.style.display = '';
      registerForm.style.display = 'none';
    };
    
    registerTab.onclick = () => {
      registerTab.classList.add('active');
      loginTab.classList.remove('active');
      loginForm.style.display = 'none';
      registerForm.style.display = '';
    };
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å¯†ç è§„åˆ™
    document.addEventListener('DOMContentLoaded', function() {
      loadPasswordRules();
      
      // æ¸…ç†æ—§çš„è®¤è¯ä¿¡æ¯ï¼ˆå¦‚æœåªæœ‰userIdè€Œæ²¡æœ‰JWTä»¤ç‰Œï¼‰
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      
      if (userId && !accessToken) {
        console.log('æ£€æµ‹åˆ°æ—§çš„è®¤è¯ä¿¡æ¯ï¼Œæ¸…ç†ä¸­...');
        localStorage.removeItem('userId');
        localStorage.removeItem('username');
      }
    });
  </script>
</body>
</html> 