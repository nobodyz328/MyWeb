<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MySteam社区 - 首页</title>
  <style>
    body { background: linear-gradient(135deg, #171a21 0%, #1b2838 100%); color: #c7d5e0; font-family: 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif; margin: 0; min-height: 100vh; }
    .steam-navbar { background: rgba(23,26,33,0.95); color: #66c0f4; box-shadow: 0 2px 8px #000a; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; height: 64px; }
    .steam-navbar .logo { font-size: 1.6rem; font-weight: bold; color: #66c0f4; }
    .steam-navbar ul { list-style: none; display: flex; gap: 32px; margin: 0; padding: 0; }
    .steam-navbar li a { color: #c7d5e0; text-decoration: none; font-size: 1.1rem; transition: color 0.2s; }
    .steam-navbar li a:hover { color: #66c0f4; }
    .main-content { display: flex; max-width: 1200px; margin: 40px auto 0 auto; gap: 32px; }
    .announcement-bar { background: #23262e; color: #fff; border-radius: 8px; padding: 16px 24px; margin-bottom: 24px; font-size: 1.1rem; box-shadow: 0 2px 8px #0006; width: 100%; }
    .post-list { flex: 2; display: flex; flex-direction: column; gap: 24px; }
    .post-card { background: #23262e; border-radius: 12px; box-shadow: 0 4px 24px #0006; padding: 24px; transition: box-shadow 0.2s; color: #fff; }
    .post-card:hover { box-shadow: 0 8px 32px #00bfff88; }
    .sidebar { flex: 1; display: flex; flex-direction: column; gap: 24px; }
    .top-liked, .hot-tags { background: #23262e; border-radius: 8px; padding: 16px 20px; color: #fff; box-shadow: 0 2px 8px #0006; }
    footer { text-align: center; color: #66c0f4; margin-top: 60px; padding: 24px 0; background: none; font-size: 1rem; opacity: 0.8; }
  </style>
</head>
<body>
  <nav class="steam-navbar">
    <div class="logo">MySteam社区</div>
    <ul id="navUser">
      <li><a href="/blog/view">首页</a></li>
      <li><a href="/blog/community">社区</a></li>
      <li><a href="/blog/announcements">公告</a></li>
      <li><a href="/blog/profile">个人中心</a></li>
      <li id="loginNav"><a href="/blog/login">登录/注册</a></li>
    </ul>
  </nav>
  <div id="userCard" style="display:none;position:fixed;top:80px;right:40px;z-index:9999;background:#23262e;border-radius:16px;box-shadow:0 4px 24px #000a;padding:32px 40px;min-width:320px;color:#fff;">
    <div style="display:flex;align-items:center;gap:24px;">
      <img id="userCardAvatar" src="https://static.hdslb.com/images/member/noface.gif" style="width:72px;height:72px;border-radius:50%;background:#1b2838;border:3px solid #66c0f4;">
      <div>
        <div id="userCardName" style="font-size:1.4rem;font-weight:bold;">用户名</div>
      </div>
    </div>
    <div style="margin:18px 0 8px 0;display:flex;align-items:center;gap:12px;">
      <div id="userCardFollow" style="text-align:center;"><div style="font-size:1.2rem;font-weight:bold;">0</div><div style="font-size:0.95rem;">关注</div></div>
      <div id="userCardFans" style="text-align:center;"><div style="font-size:1.2rem;font-weight:bold;">0</div><div style="font-size:0.95rem;">粉丝</div></div>
      <div id="userCardLike" style="text-align:center;"><div style="font-size:1.2rem;font-weight:bold;">0</div><div style="font-size:0.95rem;">获赞</div></div>
    </div>
    <button id="logoutBtn" class="steam-btn" style="margin-top:12px;width:100%;">退出登录</button>
  </div>
  <main class="main-content">
    <section class="announcement-bar">公告栏（示例）</section>
    <section class="post-list" id="allPostsList">
      <!-- 帖子卡片骨架 -->
    </section>
    <aside class="sidebar">
      <div class="top-liked">获赞前20</div>
      <div class="hot-tags">热门标签</div>
    </aside>
  </main>
  <script>
    // 异步加载所有帖子列表
    function loadAllPosts() {
      fetch('/blog/posts')
        .then(res => res.json())
        .then(posts => {
          const list = document.getElementById('allPostsList');
          if (!posts || posts.length === 0) {
            list.innerHTML = '<div style="color:#c7d5e0;">暂无帖子</div>';
            return;
          }
          list.innerHTML = posts.map(post => `
            <div class="post-card">
              <div class="post-title"><a href="/blog/posts/${post.id}" style="color:#66c0f4;">${post.title}</a></div>
              <div class="post-meta">${post.author && post.author.username ? post.author.username : ''} | ${post.createdAt ? post.createdAt.replace('T',' ').slice(0,16) : ''} | ${post.likeCount || 0} 赞 | ${post.collectCount || 0} 收藏</div>
              <div class="post-summary">${post.content ? post.content.slice(0, 80) + (post.content.length > 80 ? '...' : '') : ''}</div>
            </div>
          `).join('');
        });
    }
    loadAllPosts();
    // 登录后右上角显示用户名，点击弹出卡片
    const userId = localStorage.getItem('userId');
    if (userId) {
      fetch('/blog/users/' + userId + '/profile')
        .then(res => res.json())
        .then(data => {
          // 检查数据是否有效，防止undefined值
          const username = data && data.username ? data.username : '用户';
          const followingCount = data && data.followingCount !== undefined ? data.followingCount : 0;
          const followersCount = data && data.followersCount !== undefined ? data.followersCount : 0;
          const likedCount = data && data.likedCount !== undefined ? data.likedCount : 0;
          const avatarUrl = data && data.avatarUrl ? data.avatarUrl : 'https://static.hdslb.com/images/member/noface.gif';
          
          // 更新导航栏
          const navUser = document.getElementById('navUser');
          let userLi = document.createElement('li');
          userLi.innerHTML = `<a href="javascript:void(0);" id="navUsername">${username}</a>`;
          const loginNav = document.getElementById('loginNav');
          if (loginNav) navUser.removeChild(loginNav);
          navUser.appendChild(userLi);
          
          // 用户卡片数据
          document.getElementById('userCardName').innerText = username;
          document.getElementById('userCardFollow').children[0].innerText = followingCount;
          document.getElementById('userCardFans').children[0].innerText = followersCount;
          document.getElementById('userCardLike').children[0].innerText = likedCount;
          
          // 头像
          document.getElementById('userCardAvatar').src = avatarUrl;
          
          // 点击用户名弹出卡片
          document.getElementById('navUsername').onclick = function(e) {
            const card = document.getElementById('userCard');
            card.style.display = card.style.display === 'none' ? 'block' : 'none';
          };
          
          // 点击退出登录
          document.getElementById('logoutBtn').onclick = function() {
            localStorage.removeItem('userId');
            window.location.reload();
          };
          
          // 点击页面其他地方关闭卡片
          document.addEventListener('click', function(e) {
            const card = document.getElementById('userCard');
            if (card.style.display === 'block' && !card.contains(e.target) && e.target.id !== 'navUsername') {
              card.style.display = 'none';
            }
          });
        })
        .catch(error => {
          console.error('获取用户信息失败:', error);
          // 处理错误情况，显示默认值
          const navUser = document.getElementById('navUser');
          let userLi = document.createElement('li');
          userLi.innerHTML = `<a href="javascript:void(0);" id="navUsername">用户</a>`;
          const loginNav = document.getElementById('loginNav');
          if (loginNav) navUser.removeChild(loginNav);
          navUser.appendChild(userLi);
        });
    }
  </script>
  <footer>© 2025 MySteam社区</footer>
</body>
</html> 