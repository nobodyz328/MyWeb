name: Security Vulnerability Scan

on:
  # åœ¨æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, master, develop ]
  # åœ¨åˆ›å»º Pull Request æ—¶è§¦å‘
  pull_request:
    branches: [ main, master, develop ]
  # æ¯å‘¨å®šæœŸæ‰«æ
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Cache OWASP Dependency Check database
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository/org/owasp/dependency-check-data
        key: ${{ runner.os }}-owasp-db-${{ github.run_id }}
        restore-keys: |
          ${{ runner.os }}-owasp-db-
          
    - name: Run OWASP Dependency Check
      run: |
        cd website_core
        mvn org.owasp:dependency-check-maven:check -DfailBuildOnCVSS=7.0
        
    - name: Upload dependency check reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: dependency-check-report
        path: website_core/target/dependency-check-report/
        retention-days: 30
        
    - name: Generate security summary
      if: always()
      run: |
        cd website_core
        echo "## ğŸ”’ å®‰å…¨æ‰«æç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "target/dependency-check-report/dependency-check-report.json" ]; then
          # è§£æ JSON æŠ¥å‘Šè·å–ç»Ÿè®¡ä¿¡æ¯
          TOTAL_DEPS=$(jq '.dependencies | length' target/dependency-check-report/dependency-check-report.json)
          VULNERABLE_DEPS=$(jq '[.dependencies[] | select(.vulnerabilities)] | length' target/dependency-check-report/dependency-check-report.json)
          HIGH_VULNS=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity == "HIGH")] | length' target/dependency-check-report/dependency-check-report.json)
          MEDIUM_VULNS=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity == "MEDIUM")] | length' target/dependency-check-report/dependency-check-report.json)
          LOW_VULNS=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity == "LOW")] | length' target/dependency-check-report/dependency-check-report.json)
          
          echo "### ğŸ“Š æ‰«æç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "- **æ€»ä¾èµ–æ•°é‡**: $TOTAL_DEPS" >> $GITHUB_STEP_SUMMARY
          echo "- **å­˜åœ¨æ¼æ´çš„ä¾èµ–**: $VULNERABLE_DEPS" >> $GITHUB_STEP_SUMMARY
          echo "- **é«˜å±æ¼æ´**: $HIGH_VULNS" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¸­å±æ¼æ´**: $MEDIUM_VULNS" >> $GITHUB_STEP_SUMMARY
          echo "- **ä½å±æ¼æ´**: $LOW_VULNS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$HIGH_VULNS" -gt 0 ]; then
            echo "### âš ï¸ é«˜å±æ¼æ´è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
            jq -r '.dependencies[].vulnerabilities[]? | select(.severity == "HIGH") | "- **" + .name + "**: " + .description' target/dependency-check-report/dependency-check-report.json >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ æ‰«ææŠ¥å‘Šæ–‡ä»¶æœªæ‰¾åˆ°" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Comment PR with security results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = 'website_core/target/dependency-check-report/dependency-check-report.json';
          
          if (fs.existsSync(path)) {
            const report = JSON.parse(fs.readFileSync(path, 'utf8'));
            const totalDeps = report.dependencies.length;
            const vulnerableDeps = report.dependencies.filter(dep => dep.vulnerabilities).length;
            const highVulns = report.dependencies.flatMap(dep => dep.vulnerabilities || []).filter(vuln => vuln.severity === 'HIGH').length;
            
            const comment = `## ğŸ”’ å®‰å…¨æ‰«æç»“æœ
            
**æ‰«æå®Œæˆæ—¶é—´**: ${new Date().toLocaleString('zh-CN')}

### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
- æ€»ä¾èµ–æ•°é‡: ${totalDeps}
- å­˜åœ¨æ¼æ´çš„ä¾èµ–: ${vulnerableDeps}
- é«˜å±æ¼æ´æ•°é‡: ${highVulns}

${highVulns > 0 ? 'âš ï¸ **å‘ç°é«˜å±æ¼æ´ï¼Œè¯·åŠæ—¶å¤„ç†ï¼**' : 'âœ… **æœªå‘ç°é«˜å±æ¼æ´**'}

è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹ Actions ä¸­çš„ artifactã€‚`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }
          
    - name: Fail build on high severity vulnerabilities
      if: always()
      run: |
        cd website_core
        if [ -f "target/dependency-check-report/dependency-check-report.json" ]; then
          HIGH_VULNS=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity == "HIGH")] | length' target/dependency-check-report/dependency-check-report.json)
          if [ "$HIGH_VULNS" -gt 0 ]; then
            echo "âŒ å‘ç° $HIGH_VULNS ä¸ªé«˜å±æ¼æ´ï¼Œæ„å»ºå¤±è´¥ï¼"
            exit 1
          else
            echo "âœ… æœªå‘ç°é«˜å±æ¼æ´ï¼Œæ„å»ºé€šè¿‡ã€‚"
          fi
        fi

  # å®‰å…¨æŠ¥å‘Šåˆ†å‘ä»»åŠ¡
  distribute-reports:
    name: Distribute Security Reports
    needs: dependency-check
    runs-on: ubuntu-latest
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Download dependency check reports
      uses: actions/download-artifact@v3
      with:
        name: dependency-check-report
        path: ./reports
        
    - name: Send email notification
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.MAIL_SERVER }}
        server_port: ${{ secrets.MAIL_PORT }}
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: "MyWeb å®‰å…¨æ‰«ææŠ¥å‘Š - ${{ github.run_number }}"
        body: |
          MyWeb åšå®¢ç³»ç»Ÿå®‰å…¨æ‰«æå·²å®Œæˆã€‚
          
          æ‰«ææ—¶é—´: ${{ github.run_started_at }}
          åˆ†æ”¯: ${{ github.ref_name }}
          æäº¤: ${{ github.sha }}
          
          è¯·æŸ¥çœ‹é™„ä»¶ä¸­çš„è¯¦ç»†æŠ¥å‘Šã€‚
          
          å¦‚æœ‰é«˜å±æ¼æ´ï¼Œè¯·åŠæ—¶å¤„ç†ã€‚
        to: ${{ secrets.SECURITY_TEAM_EMAIL }}
        from: ${{ secrets.MAIL_FROM }}
        attachments: |
          ./reports/dependency-check-report.html
          ./reports/dependency-check-report.json
          
    - name: Upload to security dashboard
      if: always()
      run: |
        # è¿™é‡Œå¯ä»¥é›†æˆä¼ä¸šçš„å®‰å…¨ä»ªè¡¨æ¿
        echo "ä¸Šä¼ å®‰å…¨æŠ¥å‘Šåˆ°ä¼ä¸šå®‰å…¨ä»ªè¡¨æ¿..."
        # curl -X POST -H "Authorization: Bearer ${{ secrets.SECURITY_DASHBOARD_TOKEN }}" \
        #      -F "report=@./reports/dependency-check-report.json" \
        #      "${{ secrets.SECURITY_DASHBOARD_URL }}/api/reports"