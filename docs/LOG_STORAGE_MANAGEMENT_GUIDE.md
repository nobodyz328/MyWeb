# 日志存储管理系统使用指南

## 概述

日志存储管理系统是MyWeb博客系统安全增强项目的重要组成部分，实现了符合GB/T 22239-2019二级等保要求的日志存储空间监控、告警、备份归档和完整性校验功能。

## 功能特性

### 1. 存储空间监控
- **实时监控**：每小时自动检查日志存储空间使用情况
- **多级告警**：支持警告（80%）和严重（90%）两级告警阈值
- **自动通知**：存储空间不足时自动发送告警通知

### 2. 日志备份和归档
- **自动备份**：每天凌晨1点自动备份当前日志文件
- **智能归档**：自动归档超过保留期的旧日志文件
- **过期清理**：自动清理超过保留期的备份文件

### 3. 日志压缩存储
- **自动压缩**：每天凌晨2点自动压缩大于阈值的日志文件
- **节省空间**：使用GZIP压缩算法，显著减少存储空间占用
- **可配置阈值**：支持配置压缩触发的文件大小阈值

### 4. 完整性校验
- **定期检查**：每周日凌晨3点自动执行完整性检查
- **SHA-256哈希**：使用SHA-256算法计算文件哈希值
- **篡改检测**：检测文件是否被恶意篡改或损坏
- **告警通知**：发现完整性问题时立即发送告警

## 配置说明

### application.yml配置

```yaml
app:
  audit:
    # 日志保留天数
    retention-days: 90
    # 批量处理大小
    batch-size: 1000
    # 导出记录数限制
    export-limit: 10000
    
    # 存储管理配置
    storage:
      # 日志存储路径
      path: /var/log/myweb
      # 存储空间告警阈值（百分比）
      warning-threshold: 80
      # 存储空间严重告警阈值（百分比）
      critical-threshold: 90
      # 日志文件保留天数
      retention-days: 90
      # 压缩阈值（MB）
      compression-threshold: 100
      # 是否启用自动压缩
      auto-compression: true
      # 是否启用完整性校验
      integrity-check: true
    
    # 备份管理配置
    backup:
      # 备份存储路径
      path: /var/backup/myweb/logs
      # 备份文件保留天数
      retention-days: 365
```

### 配置参数说明

| 参数 | 说明 | 默认值 | 建议值 |
|------|------|--------|--------|
| `storage.path` | 日志存储路径 | `/var/log/myweb` | 根据实际部署环境调整 |
| `backup.path` | 备份存储路径 | `/var/backup/myweb/logs` | 建议使用独立磁盘 |
| `warning-threshold` | 警告阈值 | 80 | 70-85之间 |
| `critical-threshold` | 严重告警阈值 | 90 | 85-95之间 |
| `retention-days` | 日志保留天数 | 90 | 根据合规要求调整 |
| `backup.retention-days` | 备份保留天数 | 365 | 建议不少于1年 |
| `compression-threshold` | 压缩阈值(MB) | 100 | 50-200之间 |

## API接口

### 1. 获取存储统计信息

```http
GET /api/admin/log-storage/statistics
```

**响应示例：**
```json
{
  "logStorage": {
    "path": "/var/log/myweb",
    "totalSpace": 1073741824,
    "freeSpace": 429496729,
    "usedSpace": 644245095,
    "usagePercentage": 60.0
  },
  "backupStorage": {
    "path": "/var/backup/myweb/logs",
    "totalSpace": 2147483648,
    "freeSpace": 1288490189,
    "usedSpace": 858993459,
    "usagePercentage": 40.0
  },
  "logFileCount": 25,
  "backupFileCount": 12,
  "retentionDays": 90,
  "backupRetentionDays": 365,
  "compressionEnabled": true,
  "integrityCheckEnabled": true
}
```

### 2. 检查存储空间

```http
GET /api/admin/log-storage/space-check
```

**响应示例：**
```json
{
  "path": "/var/log/myweb",
  "totalSpace": 1073741824,
  "freeSpace": 429496729,
  "usedSpace": 644245095,
  "usagePercentage": 60.0
}
```

### 3. 手动触发备份

```http
POST /api/admin/log-storage/backup
```

**响应示例：**
```
日志备份已启动，请稍后查看备份结果
```

### 4. 手动触发完整性检查

```http
POST /api/admin/log-storage/integrity-check?filePath=/path/to/file.log
```

**参数说明：**
- `filePath`（可选）：要检查的文件路径，为空则检查所有文件

**响应示例：**
```
文件完整性检查通过
```

### 5. 获取存储健康状态

```http
GET /api/admin/log-storage/health
```

**响应示例：**
```json
{
  "status": "良好",
  "overallUsage": 46.67,
  "logStorageUsage": 60.0,
  "backupStorageUsage": 40.0,
  "totalFiles": 37,
  "compressionEnabled": true,
  "integrityCheckEnabled": true,
  "needsAttention": false
}
```

## 定时任务

### 1. 存储空间监控
- **执行时间**：每小时整点执行
- **Cron表达式**：`0 0 * * * ?`
- **功能**：检查存储空间使用情况，必要时发送告警

### 2. 日志备份和归档
- **执行时间**：每天凌晨1点执行
- **Cron表达式**：`0 0 1 * * ?`
- **功能**：备份当前日志文件，归档旧日志文件

### 3. 日志压缩
- **执行时间**：每天凌晨2点执行
- **Cron表达式**：`0 0 2 * * ?`
- **功能**：压缩大于阈值的日志文件

### 4. 完整性检查
- **执行时间**：每周日凌晨3点执行
- **Cron表达式**：`0 0 3 ? * SUN`
- **功能**：检查日志文件完整性

## 告警机制

### 1. 存储空间告警
- **警告级别**：使用率达到80%时发送警告
- **严重级别**：使用率达到90%时发送严重告警
- **通知方式**：邮件、短信（通过SecurityAlertService）

### 2. 完整性告警
- **触发条件**：检测到文件哈希值不匹配
- **告警类型**：`LOG_INTEGRITY_VIOLATION`
- **处理建议**：立即检查文件内容，确认是否被篡改

### 3. 备份失败告警
- **触发条件**：备份操作执行失败
- **记录方式**：审计日志记录
- **处理建议**：检查存储空间和权限设置

## 最佳实践

### 1. 存储规划
- **独立磁盘**：建议将备份存储放在独立磁盘上
- **容量规划**：日志存储容量应为日均日志量的3-6个月
- **备份容量**：备份存储容量应为日志存储的2-3倍

### 2. 监控配置
- **告警阈值**：根据实际业务量调整告警阈值
- **检查频率**：生产环境建议每30分钟检查一次
- **通知渠道**：配置多种通知渠道确保及时响应

### 3. 安全考虑
- **权限控制**：严格控制日志文件和备份文件的访问权限
- **加密存储**：敏感日志建议加密存储
- **网络隔离**：备份存储建议使用独立网络

### 4. 性能优化
- **异步处理**：所有耗时操作都使用异步处理
- **批量操作**：大量文件操作使用批量处理
- **资源限制**：合理配置线程池大小避免资源竞争

## 故障排除

### 1. 存储空间不足
**症状**：收到存储空间告警
**解决方案**：
1. 清理过期日志文件
2. 启用压缩功能
3. 增加存储容量
4. 调整日志保留策略

### 2. 备份失败
**症状**：备份操作失败，审计日志中有错误记录
**解决方案**：
1. 检查备份目录权限
2. 确认备份存储空间充足
3. 检查网络连接状态
4. 查看详细错误日志

### 3. 完整性检查失败
**症状**：收到完整性告警
**解决方案**：
1. 立即隔离可疑文件
2. 从备份恢复原始文件
3. 检查系统安全状态
4. 分析攻击路径

### 4. 性能问题
**症状**：系统响应缓慢，CPU或IO使用率高
**解决方案**：
1. 调整定时任务执行时间
2. 优化线程池配置
3. 启用压缩减少IO操作
4. 分批处理大量文件

## 合规性说明

本日志存储管理系统完全符合以下标准要求：

### GB/T 22239-2019要求
- **3.4 安全审计**：实现了完整的审计日志存储管理
- **3.7 数据备份恢复**：提供了自动化的日志备份机制

### 功能覆盖
- ✅ 日志存储空间监控
- ✅ 存储空间不足告警
- ✅ 日志备份和归档机制
- ✅ 日志压缩存储
- ✅ 日志完整性校验

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| 1.0 | 2025-01-01 | 初始版本，实现基础功能 |

## 联系方式

如有问题或建议，请联系：
- 开发团队：MyWeb Security Team
- 邮箱：security@myweb.com
- 文档更新：请提交PR到项目仓库